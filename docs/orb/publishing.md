# CircleCI orb, publishing and integration

An orb has been published to assist in sharing the logic to integrate the end-to-end test suite into the CircleCI pipelines of the crime forms repositories.

## Orb publishing in CI pipeline

The orb is defined as a single `orb.yml` file in the root of this repo and is published by this repository's CircleCI pipeline. A branch of this repo will publish a new dev version of the orb.

```sh
ministryofjustice/crime-forms-end-to-end-tests@dev:alpha
```

Merging a branch into `main` will trigger publishing of a production orb, automatically incrementing the `patch` semver number. You can manually alter the `patch` argument to `major` or `minor` temporarily to increment these semvers. Please remember to set back to `patch` afterward.

```
ministryofjustice/crime-forms-end-to-end-tests@0.0.x
```

Both publishing types (dev, production) require a CircleCI context with a single environment variable - CIRCLE_TOKEN\*. This token is stored in the `laa-crime-forms-orb-publishing` context. It is also stored in 1password.

\*_This CIRCLE_TOKEN token must have github organisation/ministryofjustice level permissions and can only be generated by someone with those permissions. See #ask-operations-engineering slack channel and team as required_

## Orb publishing from your terminal

If you have the circleci CLI installed on your machine you can publish both the dev and production orb from your terminal.

```sh
#  publish dev orb from terminal
cd my-orb-repo-with-orb-yml-file-at-its-root

export CIRCLE_TOKEN=<organisation-level-circleci-tokenâ‰¥

circleci orb publish \
    --skip-update-check \
    orb.yml \
    ministryofjustice/crime-forms-end-to-end-tests@dev:alpha \
    --token $CIRCLE_TOKEN
```

## Viewing orbs

To see the latest available production orb versions across the organisation you can visit the [ministryofjustice org's orb list](https://app.circleci.com/settings/organization/gh/ministryofjustice/orbs)

The [production orb generated by this repo is viewable here ](https://circleci.com/developer/orbs/orb/ministryofjustice/crime-forms-end-to-end-tests)

You can view any orb's source from the terminal using the circleci CLI

```sh
# view current dev:alpha published orb
circleci orb source ministryofjustice/crime-forms-end-to-end-tests@dev:alpha

# view first version of the production orb
circleci orb source ministryofjustice/crime-forms-end-to-end-tests@0.0.1

# view historical version of a third party orb
circleci orb source circleci/orb-tools@10.1.0
```

name: "Run E2E Tests"
description: "Run end-to-end tests for the LAA crime forms services"

on:
  workflow_call:
    inputs:
      submit-sha:
        description: 'SHA hash of the container image to use for laa-submit-crime-forms'
        default: 'latest'
        required: false
        type: string
      assess-sha:
        description: 'SHA hash of the container image to use for laa-assess-crime-forms'
        default: 'latest'
        required: false
        type: string
      appstore-sha:
        description: 'SHA hash of the container image to use for laa-crime-application-store'
        default: 'latest'
        required: false
        type: string


jobs:
  run-e2e-tests:
    name: "Run E2E Tests"
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      NSCC_PROVIDER_IMAGE: ${{ secrets.ECR_REGISTRY_URL }}/${{ vars.SUBMIT_DEV_ECR_REPOSITORY }}:${{ inputs.submit-sha }}
      NSCC_APPSTORE_IMAGE: ${{ secrets.ECR_REGISTRY_URL }}/${{ vars.APP_STORE_DEV_ECR_REPOSITORY }}:${{ inputs.appstore-sha }}
      NSCC_CASEWORKER_IMAGE: ${{ secrets.ECR_REGISTRY_URL }}/${{ vars.ASSESS_DEV_ECR_REPOSITORY }}:${{ inputs.assess-sha }}      
    steps:
      - name: Checkout E2E Test Repository
        uses: actions/checkout@v3
        with:
          repository: ministryofjustice/nsm-e2e-test
          path: e2e-tests

      - name: Install docker-compose
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: docker-compose
          version: 1.0

      # laa-submit-crime-forms
      - name: Configure AWS credentials for laa-submit-crime-forms
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@e5500aa20b13a1406fe8a62b8788181a2ca18926
        with:
          ecr_role: ${{ secrets.SUBMIT_DEV_ECR_ROLE_TO_ASSUME }}
          ecr_region: ${{ vars.SUBMIT_DEV_ECR_REGION }}
          role-session-name: ${{ vars.ECR_ROLE_SESSION_NAME }}

      - name: Pull laa-submit-crime-forms image
        shell: bash
        working-directory: e2e-tests
        run: docker pull $NSCC_PROVIDER_IMAGE

      # laa-crime-application-store
      - name: Configure AWS credentials for laa-crime-application-store
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@e5500aa20b13a1406fe8a62b8788181a2ca18926
        with:
          ecr_role: ${{ secrets.APP_STORE_DEV_ECR_ROLE_TO_ASSUME }}
          ecr_region: ${{ vars.APP_STORE_DEV_ECR_REGION }}
          role-session-name: ${{ vars.ECR_ROLE_SESSION_NAME }}

      - name: Pull laa-crime-application-store image
        shell: bash
        working-directory: e2e-tests
        run: docker pull $NSCC_APPSTORE_IMAGE

      # laa-assess-crime-forms
      - name: Configure AWS credentials for laa-assess-crime-forms
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@e5500aa20b13a1406fe8a62b8788181a2ca18926
        with:
          ecr_role: ${{ secrets.ASSESS_DEV_ECR_ROLE_TO_ASSUME }}
          ecr_region: ${{ vars.ASSESS_DEV_ECR_REGION }}
          role-session-name: ${{ vars.ECR_ROLE_SESSION_NAME }}

      - name: Pull NSCC laa-assess-crime-forms image
        shell: bash
        working-directory: e2e-tests
        run: docker pull $NSCC_CASEWORKER_IMAGE

      - name: Build and check/wait for services
        shell: bash
        working-directory: e2e-tests
        run: |
          docker-compose build --no-cache
          docker-compose run start_applications

      - name: Run end-to-end tests
        shell: bash
        working-directory: e2e-tests
        run: docker-compose run laa-crime-forms-end-to-end-tests

      - name: Output container logs on failure
        if: failure()
        shell: bash
        working-directory: e2e-tests
        run: docker-compose logs
